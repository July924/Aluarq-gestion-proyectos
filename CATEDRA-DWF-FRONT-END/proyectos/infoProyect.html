<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles del Proyecto - Alu-Arq</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!-- css -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/info.css">
    <link rel="stylesheet" href="../css/list.css">
</head>
<body>
    <!-- Header -->
    <header class="header-bg py-4 mb-4">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h4 mb-0"><i class="fas fa-user-tie me-2"></i> Detalle de Proyectos</h1>
                <a href="listsProyects.html" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left me-1"></i> Volver al listado
                </a>
            </div>
        </div>
    </header>
    
    <!-- Encabezado del proyecto moderno -->
    <div class="modern-project-header">
        <div class="container">
            <div class="project-title-container">
                <div class="project-icon">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div>
                    <h1 class="project-title" id="projectName">Cargando proyecto...</h1>
                    <div class="project-meta">
                        <span class="project-status" id="projectStatus">Estado</span>
                        <span class="project-code">
                            <i class="fas fa-hashtag"></i>
                            <span id="projectCode">Código</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row">
            <!-- Columna izquierda - Información principal -->
            <div class="col-lg-8">
                <!-- Información básica -->
                <div class="card info-card mb-4">
                    <div class="card-header bg-blue-600">
                        <i class="fas fa-info-circle me-2"></i>Información básica
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <div class="label">Fecha de inicio</div>
                                    <div class="value" id="startDate">--/--/----</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <div class="label">Fecha estimada de finalización</div>
                                    <div class="value" id="endDate">--/--/----</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <div class="label">Ubicación</div>
                                    <div class="value" id="projectLocation">No especificada</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="detail-item">
                                    <div class="label">Arquitecto encargado</div>
                                    <div class="value" id="projectManager">No asignado</div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="detail-item">
                                    <div class="label">Descripción</div>
                                    <div class="value" id="projectDescription">
                                        No hay descripción disponible
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Presupuesto -->
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <i class="fas fa-money-bill-wave me-2"></i>Presupuesto
                    </div>
                    <div class="card-body">
                        <div class="budget-item">
                            <span>Presupuesto de materiales</span>
                            <span id="materialBudget">$0</span>
                        </div>
                        <div class="budget-item">
                            <span>Viáticos asignados</span>
                            <span id="viaticosBudget">$0</span>
                        </div>
                        <div class="budget-item">
                            <span>Total</span>
                            <span id="totalBudget">$0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Equipo de trabajo -->
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <i class="fas fa-users me-2"></i>Equipo asignado (<span id="teamCount">0</span>)
                    </div>
                    <div class="card-body" id="teamMembersContainer">
                        <div class="team-member">
                            <div>
                                <div class="fw-bold">Cargando equipo...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Columna derecha - Información adicional -->
            <div class="col-lg-4">
                <!-- Documentos -->
                <div class="card info-card mb-4">
                    <div class="card-header">
                        <i class="fas fa-file-alt me-2"></i>Documentos
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush" id="documentsList">
                            <div class="text-muted py-3">No hay documentos cargados</div>
                        </div>
                        <div class="text-center pt-3">
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                <i class="fas fa-plus me-1"></i> Subir documento
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Materiales utilizados -->
        <div class="card info-card mb-4">
            <div class="card-header">
                <i class="fas fa-tools me-2"></i>Materiales utilizados
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table" id="materialsTable">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Cantidad</th>
                                <th>Unidad</th>
                                <th>Precio Unitario</th>
                                <th>Subtotal</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="materialsList">
                            <tr>
                                <td colspan="6" class="text-center">No hay materiales registrados</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-end fw-bold">Total materiales:</td>
                                <td class="fw-bold" id="totalMaterials">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- Botón para agregar nuevo material -->
                <button class="btn btn-primary btn-sm" id="addMaterialBtn">
                    <i class="fas fa-plus me-1"></i> Agregar Material
                </button>
            </div>
        </div>

        <!-- Modal para agregar materiales -->
        <div class="modal fade" id="materialModal" tabindex="-1" aria-labelledby="materialModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="materialModalLabel">Agregar Material al Proyecto</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="materialForm">
                            <div class="mb-3">
                                <label for="materialName" class="form-label">Nombre del Material</label>
                                <input type="text" class="form-control" id="materialName" required>
                            </div>
                            <div class="mb-3">
                                <label for="materialQuantity" class="form-label">Cantidad</label>
                                <input type="number" class="form-control" id="materialQuantity" min="0.1" step="0.1" required>
                            </div>
                            <div class="mb-3">
                                <label for="materialUnit" class="form-label">Unidad de Medida</label>
                                <select class="form-select" id="materialUnit" required>
                                    <option value="" selected disabled>Seleccione una unidad</option>
                                    <!-- Las opciones se cargarán dinámicamente desde la BD -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="materialPrice" class="form-label">Precio Unitario</label>
                                <input type="number" class="form-control" id="materialPrice" min="0" step="0.01" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="saveMaterialBtn">Guardar Material</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Acciones -->
        <div class="d-flex justify-content-end mt-4">
            <div class="btn-group">
                <a href="editarProyecto.html?id=${project.idProyecto}" id="editProjectLink">
                    <button class="btn btn-outline-secondary">
                        <i class="fas fa-edit me-1"></i> Editar
                    </button>
                </a>
                <button class="btn btn-outline-danger" id="deleteProjectBtn" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
                    <i class="fas fa-trash me-1"></i> Eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para subir documentos -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Subir documento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="documentUploadForm">
                        <div class="mb-3">
                            <label for="documentFile" class="form-label">Seleccionar archivo</label>
                            <input class="form-control" type="file" id="documentFile" required>
                            <div class="file-info" id="fileInfo"></div>
                        </div>
                        <div class="mb-3">
                            <label for="documentName" class="form-label">Nombre del documento</label>
                            <input type="text" class="form-control" id="documentName" placeholder="Nombre descriptivo" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="uploadDocumentBtn">Subir documento</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar proyecto -->
    <div class="modal fade modal-confirm" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-exclamation-triangle fa-4x text-danger mb-4"></i>
                    <h4>¿Estás seguro de eliminar este proyecto?</h4>
                    <p>Esta acción no se puede deshacer. Todos los datos del proyecto se perderán permanentemente.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Eliminar Proyecto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // URL de la API
        const API_URL = 'http://localhost:8080/api/proyectos';
        const UNIDADES_MEDIDA_URL = 'http://localhost:8080/api/catalogo/unidadesmedida';
        
        // Obtener el ID del proyecto de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        
        // URL para materiales del proyecto específico
        const MATERIALES_PROYECTO_URL = `http://localhost:8080/api/materiales-proyecto/proyecto/${projectId}`;
        const MATERIALES_BASE_URL = `http://localhost:8080/api/materiales-proyecto/proyecto/${projectId}`;
        
        // Clave para almacenar documentos en localStorage
        const DOCUMENTS_KEY = `project_documents_${projectId}`;

        // Función para formatear fecha
        function formatDate(dateString) {
            if (!dateString) return 'No definida';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES');
        }
        
        // Función para formatear moneda
        function formatCurrency(amount) {
            return '$' + (amount || 0).toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Función para obtener el nombre del empleado
        function getEmpleadoName(empleado) {
            if (!empleado || !empleado.nombreEmpleado) return 'No asignado';
            return empleado.nombreEmpleado;
        }
        
        // Función para obtener la clase CSS según el estado
        function getStatusClass(status) {
            const statusClasses = {
                'En Planificación': 'status-planning',
                'En Progreso': 'status-progress',
                'Pausado': 'status-paused',
                'Completado': 'status-completed'
            };
            return statusClasses[status] || '';
        }
        
        // Función para cargar documentos desde localStorage
        function loadDocuments() {
            const documentsList = document.getElementById('documentsList');
            const documents = JSON.parse(localStorage.getItem(DOCUMENTS_KEY)) || [];
            
            if (documents.length === 0) {
                documentsList.innerHTML = '<div class="text-muted py-3">No hay documentos cargados</div>';
                return;
            }
            
            documentsList.innerHTML = '';
            documents.forEach((doc, index) => {
                const listItem = document.createElement('a');
                listItem.className = 'list-group-item list-group-item-action';
                listItem.innerHTML = `
                    <div class="document-item">
                        <div>
                            <i class="${getFileIcon(doc.type)} me-2"></i>
                            ${doc.name}
                        </div>
                        <div class="document-actions">
                            <button class="btn btn-sm btn-outline-primary download-btn" data-index="${index}">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                documentsList.appendChild(listItem);
            });
            
            // Agregar event listeners a los botones
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', (e) => downloadDocument(e.target.dataset.index));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteDocument(e.target.dataset.index));
            });
        }
        
        // Función para obtener icono según tipo de archivo
        function getFileIcon(fileType) {
            const icons = {
                'pdf': 'fas fa-file-pdf text-danger',
                'doc': 'fas fa-file-word text-primary',
                'docx': 'fas fa-file-word text-primary',
                'xls': 'fas fa-file-excel text-success',
                'xlsx': 'fas fa-file-excel text-success',
                'jpg': 'fas fa-file-image text-info',
                'jpeg': 'fas fa-file-image text-info',
                'png': 'fas fa-file-image text-info',
                'default': 'fas fa-file text-secondary'
            };
            
            const extension = fileType.split('/').pop().toLowerCase();
            return icons[extension] || icons['default'];
        }
        
        // Función para descargar documento
        function downloadDocument(index) {
            const documents = JSON.parse(localStorage.getItem(DOCUMENTS_KEY)) || [];
            const doc = documents[index];
            
            if (!doc) return;
            
            // Crear un enlace temporal para la descarga
            const link = document.createElement('a');
            link.href = doc.content;
            link.download = doc.fileName || `documento_${index}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Función para eliminar documento
        function deleteDocument(index) {
            if (!confirm('¿Estás seguro de que deseas eliminar este documento?')) return;
            
            const documents = JSON.parse(localStorage.getItem(DOCUMENTS_KEY)) || [];
            documents.splice(index, 1);
            localStorage.setItem(DOCUMENTS_KEY, JSON.stringify(documents));
            loadDocuments();
        }
        
        // Función para cargar los datos del proyecto
        async function loadProjectData() {
            if (!projectId) {
                alert('No se ha especificado un proyecto');
                window.location.href = 'listsProyects.html';
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/${projectId}`);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const project = await response.json();
                renderProjectData(project);
                
            } catch (error) {
                console.error('Error al cargar el proyecto:', error);
                document.getElementById('projectName').textContent = 'Error al cargar el proyecto';
                document.getElementById('projectDescription').textContent = error.message;
            }
        }
        
        // Función para renderizar los datos del proyecto
        function renderProjectData(project) {
            // Encabezado
            document.getElementById('projectName').textContent = project.nombreProyecto;
            document.getElementById('projectCode').textContent = `PRO-${project.idProyecto}`;
            
            const statusElement = document.getElementById('projectStatus');
            statusElement.textContent = project.estadoProyecto;
            statusElement.className = `status-badge ${getStatusClass(project.estadoProyecto)}`;
            
            // Información básica
            document.getElementById('startDate').textContent = formatDate(project.fechaInicio);
            document.getElementById('endDate').textContent = formatDate(project.fechaFin);
            document.getElementById('projectLocation').textContent = project.ubicacionProyecto || 'No especificada';
            document.getElementById('projectManager').textContent = getEmpleadoName(project.empleado);
            document.getElementById('projectDescription').textContent = project.descripcionProyecto || 'No hay descripción disponible';
            
            // Presupuesto
            document.getElementById('materialBudget').textContent = formatCurrency(project.presupuestoMateriales);
            document.getElementById('viaticosBudget').textContent = formatCurrency(project.viaticosAsignados);
            
            const totalBudget = (project.presupuestoMateriales || 0) + (project.viaticosAsignados || 0);
            document.getElementById('totalBudget').textContent = formatCurrency(totalBudget);
            
            // Equipo
            const teamCount = project.numeroTrabajadores || 0;
            document.getElementById('teamCount').textContent = teamCount;
            
            const teamContainer = document.getElementById('teamMembersContainer');
            if (teamCount > 0) {
                teamContainer.innerHTML = `
                    <div class="team-member">
                        <div>
                            <div class="fw-bold">${getEmpleadoName(project.empleado)}</div>
                            <div class="text-muted small">Arquitecto encargado</div>
                        </div>
                    </div>
                    <div class="text-muted small mt-2">+ ${teamCount - 1} miembros más del equipo</div>
                `;
            } else {
                teamContainer.innerHTML = '<div class="text-muted">No hay miembros asignados al equipo</div>';
            }
            
            // Configurar enlace de edición
            document.getElementById('editProjectLink').href = `editarProyecto.html?id=${project.idProyecto}`;
            
            // Configurar botón de eliminar
            const deleteBtn = document.getElementById('deleteProjectBtn');
            deleteBtn.addEventListener('click', function() {
                // Configurar el botón de confirmación dentro del modal
                document.getElementById('confirmDeleteBtn').onclick = function() {
                    deleteProject(project.idProyecto);
                };
            });
            
            // Cargar documentos
            loadDocuments();
        }
        
        // Función para eliminar el proyecto
        async function deleteProject(id) {
            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                // Eliminar también los documentos asociados
                localStorage.removeItem(DOCUMENTS_KEY);
                
                // Cerrar el modal de confirmación
                const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
                modal.hide();
                
                // Mostrar mensaje de éxito y redirigir
                alert('Proyecto eliminado correctamente');
                window.location.href = 'listsProyects.html';
                
            } catch (error) {
                console.error('Error al eliminar el proyecto:', error);
                alert(`Error al eliminar el proyecto: ${error.message}`);
            }
        }
        
        // Event listener para el input de archivo
        document.getElementById('documentFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileInfo').textContent = 
                    `Archivo seleccionado: ${file.name} (${formatFileSize(file.size)})`;
                
                // Autocompletar nombre si está vacío
                if (!document.getElementById('documentName').value) {
                    const fileNameWithoutExt = file.name.split('.').slice(0, -1).join('.');
                    document.getElementById('documentName').value = fileNameWithoutExt;
                }
            }
        });
        
        // Función para formatear tamaño de archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Event listener para subir documento
        document.getElementById('uploadDocumentBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('documentFile');
            const nameInput = document.getElementById('documentName');
            
            if (!fileInput.files.length) {
                alert('Por favor selecciona un archivo');
                return;
            }
            
            if (!nameInput.value.trim()) {
                alert('Por favor ingresa un nombre para el documento');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const documents = JSON.parse(localStorage.getItem(DOCUMENTS_KEY)) || [];
                
                documents.push({
                    name: nameInput.value.trim(),
                    fileName: file.name,
                    type: file.type,
                    size: file.size,
                    lastModified: file.lastModified,
                    content: e.target.result,
                    uploadedAt: new Date().toISOString()
                });
                
                localStorage.setItem(DOCUMENTS_KEY, JSON.stringify(documents));
                
                // Cerrar modal y resetear formulario
                const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
                modal.hide();
                document.getElementById('documentUploadForm').reset();
                document.getElementById('fileInfo').textContent = '';
                
                // Recargar lista de documentos
                loadDocuments();
            };
            
            reader.readAsDataURL(file);
        });

        // Variables para materiales
        let materials = [];
        let unidadesMedida = [];

        // Función para cargar unidades de medida desde la BD
        async function loadUnidadesMedida() {
            try {
                const response = await fetch(UNIDADES_MEDIDA_URL);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                unidadesMedida = await response.json();
                populateUnidadesMedida();
                
            } catch (error) {
                console.error('Error al cargar las unidades de medida:', error);
                alert('Error al cargar las unidades de medida');
            }
        }

        // Función para poblar el select de unidades de medida
        function populateUnidadesMedida() {
            const select = document.getElementById('materialUnit');
            select.innerHTML = '<option value="" selected disabled>Seleccione una unidad</option>';
            
            unidadesMedida.forEach(unidad => {
                const option = document.createElement('option');
                option.value = unidad.idUnidadMedida;
                option.textContent = unidad.nombreUnidad;
                select.appendChild(option);
            });
        }

        // Función para cargar materiales del proyecto
        async function loadProjectMaterials() {
            try {
                const response = await fetch(MATERIALES_PROYECTO_URL);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                materials = await response.json();
                renderMaterialsList();
                
            } catch (error) {
                console.error('Error al cargar los materiales:', error);
                alert('Error al cargar los materiales del proyecto');
            }
        }

        // Función para renderizar la lista de materiales
        function renderMaterialsList() {
            const materialsList = document.getElementById('materialsList');
            
            if (!materials || materials.length === 0) {
                materialsList.innerHTML = '<tr><td colspan="6" class="text-center">No hay materiales registrados</td></tr>';
                document.getElementById('totalMaterials').textContent = '$0.00';
                return;
            }
            
            materialsList.innerHTML = '';
            let total = 0;
            
            materials.forEach((material) => {
                const subtotal = material.subtotal || (material.cantidadUtilizada * material.precioUnitario) || 0;
                total += subtotal;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${material.nombreMaterial || 'Sin nombre'}</td>
                    <td>${material.cantidadUtilizada || 0}</td>
                    <td>${getUnitName(material.idUnidadMedida)}</td>
                    <td>${formatCurrency(material.precioUnitario || 0)}</td>
                    <td>${formatCurrency(subtotal)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger delete-material-btn" data-id="${material.idMaterialProyecto || ''}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                materialsList.appendChild(row);
            });
            
            document.getElementById('totalMaterials').textContent = formatCurrency(total);
            
            // Agregar event listeners a los botones de eliminar
            document.querySelectorAll('.delete-material-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const materialId = e.target.closest('button').dataset.id;
                    if (materialId) {
                        deleteMaterial(materialId);
                    }
                });
            });
        }

        // Función para obtener nombre de unidad
        function getUnitName(unitId) {
            if (!unidadesMedida || !unidadesMedida.length) {
                return '--';
            }
            const unidad = unidadesMedida.find(u => u.idUnidadMedida == unitId);
            return unidad ? unidad.nombreUnidad : '--';
        }

        // Función para agregar nuevo material - CORREGIDA
        async function addMaterial() {
            const materialName = document.getElementById('materialName').value.trim();
            const quantity = parseFloat(document.getElementById('materialQuantity').value);
            const unitId = document.getElementById('materialUnit').value;
            const price = parseFloat(document.getElementById('materialPrice').value);
            
            // Validaciones mejoradas
            if (!materialName) {
                alert('Por favor ingrese un nombre para el material');
                return;
            }
            
            if (isNaN(quantity) || quantity <= 0) {
                alert('Por favor ingrese una cantidad válida (mayor que cero)');
                return;
            }
            
            if (!unitId) {
                alert('Por favor seleccione una unidad de medida');
                return;
            }
            
            if (isNaN(price) || price <= 0) {
                alert('Por favor ingrese un precio unitario válido (mayor que cero)');
                return;
            }
            
            const subtotal = quantity * price;
            
            const newMaterial = {
                nombreMaterial: materialName,
                cantidadUtilizada: quantity,  // Nombre de propiedad corregido
                idUnidadMedida: parseInt(unitId),
                precioUnitario: price,
                idProyecto: parseInt(projectId),
                subtotal: subtotal  // Incluir el subtotal calculado
            };
            
            console.log('Enviando material:', newMaterial); // Para depuración
            
            try {
                const response = await fetch(MATERIALES_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newMaterial)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Error ${response.status}: ${response.statusText}`);
                }
                
                // Recargar la lista de materiales después de agregar uno nuevo
                await loadProjectMaterials();
                
                // Cerrar modal y resetear formulario
                const modal = bootstrap.Modal.getInstance(document.getElementById('materialModal'));
                modal.hide();
                document.getElementById('materialForm').reset();
                
            } catch (error) {
                console.error('Error al guardar el material:', error);
                alert('Error al guardar el material: ' + error.message);
            }
        }

        // Función para eliminar material
        async function deleteMaterial(materialId) {
            if (!confirm('¿Estás seguro de que deseas eliminar este material?')) return;
            
            try {
                const response = await fetch(`${MATERIALES_BASE_URL}/${materialId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                // Recargar la lista de materiales después de eliminar
                await loadProjectMaterials();
                
            } catch (error) {
                console.error('Error al eliminar el material:', error);
                alert('Error al eliminar el material: ' + error.message);
            }
        }

        // Event listeners para materiales
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar materiales y unidades de medida cuando la página esté lista
            if (projectId) {
                loadProjectMaterials();
                loadUnidadesMedida();
            }
            
            // Abrir modal para agregar material
            document.getElementById('addMaterialBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('materialModal'));
                modal.show();
            });
            
            // Guardar material
            document.getElementById('saveMaterialBtn').addEventListener('click', addMaterial);
        });
        
        // Cargar los datos cuando la página esté lista
        document.addEventListener('DOMContentLoaded', loadProjectData);
    </script>
</body>
</html>