<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Proyecto - Alu-Arq</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!-- CSS -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/form.css">
    
</head>
<body>
    <header class="header-bg py-4 mb-4">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h4 mb-0"><i class="fas fa-edit me-2"></i> Editar Proyecto</h1>
            </div>
        </div>
    </header>

    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card form-card">
                    <div class="card-body">
                        <form id="editProjectForm">
                            <input type="hidden" id="projectId">
                            
                            <!-- Sección Información Básica -->
                            <h5 class="section-title"><i class="fas fa-info-circle me-2"></i>Información Básica</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="projectName" class="form-label required-field">Nombre del Proyecto</label>
                                    <input type="text" class="form-control" id="projectName" name="projectName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="projectCode" class="form-label required-field">Código</label>
                                    <input type="text" class="form-control" id="projectCode" name="projectCode" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="projectType" class="form-label required-field">Tipo de Proyecto</label>
                                    <select class="form-select" id="projectType" name="projectType" required>
                                        <option value="Residencial">Residencial</option>
                                        <option value="Comercial">Comercial</option>
                                        <option value="Industrial">Industrial</option>
                                        <option value="Institucional">Institucional</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="projectStatus" class="form-label required-field">Estado</label>
                                    <select class="form-select" id="projectStatus" name="projectStatus" required>
                                        <option value="En Planificación">Planificación</option>
                                        <option value="En Progreso">En Progreso</option>
                                        <option value="Pausado">Pausado</option>
                                        <option value="Completado">Completado</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label for="projectDescription" class="form-label">Descripción</label>
                                    <textarea class="form-control" id="projectDescription" name="projectDescription" rows="3"></textarea>
                                </div>
                                <div class="col-12">
                                    <label for="projectLocation" class="form-label required-field">Ubicación</label>
                                    <input type="text" class="form-control" id="projectLocation" name="projectLocation" required>
                                </div>
                            </div>

                            <!-- Sección Fechas -->
                            <h5 class="section-title"><i class="fas fa-calendar-alt me-2"></i>Fechas</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="startDate" class="form-label required-field">Fecha de Inicio</label>
                                    <input type="date" class="form-control" id="startDate" name="startDate" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="endDate" class="form-label required-field">Fecha Estimada de Finalización</label>
                                    <input type="date" class="form-control" id="endDate" name="endDate" required>
                                </div>
                            </div>

                            <!-- Sección Recursos -->
                            <h5 class="section-title"><i class="fas fa-users me-2"></i>Recursos</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="projectArchitect" class="form-label required-field">Arquitecto Encargado</label>
                                    <select class="form-select" id="projectArchitect" name="projectArchitect" required>
                                        <!-- Opciones se cargarán dinámicamente -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="workersCount" class="form-label required-field">Número de Trabajadores</label>
                                    <input type="number" class="form-control" id="workersCount" name="workersCount" min="1" required>
                                </div>
                            </div>

                            <!-- Sección Presupuesto -->
                            <h5 class="section-title"><i class="fas fa-money-bill-wave me-2"></i>Presupuesto</h5>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="materialsBudget" class="form-label required-field">Presupuesto Materiales ($)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="materialsBudget" name="materialsBudget" min="0" step="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="viaticBudget" class="form-label required-field">Viáticos ($)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="viaticBudget" name="viaticBudget" min="0" step="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="totalBudget" class="form-label">Total ($)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="text" class="form-control" id="totalBudget" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-5">
                                <button type="button" id="cancelButton" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Guardar Cambios
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // URL de la API
        const API_URL = 'http://localhost:8080/api/proyectos';
        const EMPLEADOS_URL = 'http://localhost:8080/api/empleados';
        
        
        // Obtener el ID del proyecto de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        
        // Cargar datos del proyecto y empleados
        document.addEventListener('DOMContentLoaded', async function() {
            
            if (!projectId) {
                alert('No se ha especificado un proyecto');
                window.location.href = 'listsProyects.html';
                return;
            }
            
            try {
                // Cargar datos del proyecto
                const response = await fetch(`${API_URL}/${projectId}`);
                if (!response.ok) throw new Error(`Error ${response.status}: ${response.statusText}`);
                const project = await response.json();
                
                // Cargar lista de empleados
                const empleadosResponse = await fetch(EMPLEADOS_URL);
                if (!empleadosResponse.ok) throw new Error(`Error al cargar empleados`);
                const empleados = await empleadosResponse.json();

                
                
                // Llenar formulario con datos del proyecto
                populateForm(project, empleados);
                
                // Configurar botón de volver
                document.getElementById('cancelButton').addEventListener('click', () => {
                    window.location.href = `infoProyect.html?id=${projectId}`;
                });
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
                alert(`Error al cargar datos del proyecto: ${error.message}`);
                window.location.href = 'listsProyects.html';
            }
        });
        
        // Función para llenar el formulario con datos del proyecto
        function populateForm(project, empleados) {
            document.getElementById('projectId').value = project.idProyecto;
            document.getElementById('projectName').value = project.nombreProyecto;
            document.getElementById('projectCode').value = `PRO-${project.idProyecto}`;
            document.getElementById('projectType').value = project.tipoProyecto;
            document.getElementById('projectStatus').value = project.estadoProyecto;
            document.getElementById('projectDescription').value = project.descripcionProyecto || '';
            document.getElementById('projectLocation').value = project.ubicacionProyecto;
            document.getElementById('startDate').value = project.fechaInicio.split('T')[0];
            document.getElementById('endDate').value = project.fechaFin.split('T')[0];
            document.getElementById('workersCount').value = project.numeroTrabajadores || 0;
            document.getElementById('materialsBudget').value = project.presupuestoMateriales;
            document.getElementById('viaticBudget').value = project.viaticosAsignados;
            
            // Calcular total
            calculateTotal();
            
            // Llenar select de arquitectos
            const architectSelect = document.getElementById('projectArchitect');
            architectSelect.innerHTML = '';
            
            empleados.forEach(empleado => {
                const option = document.createElement('option');
                option.value = empleado.idEmpleado;
                option.textContent = empleado.nombreEmpleado;
                
                // Seleccionar el arquitecto actual si existe
                if (project.empleado && empleado.idEmpleado === project.empleado.idEmpleado) {
                    option.selected = true;
                }
                
                architectSelect.appendChild(option);
            });
        }
        
        // Cálculo automático del total
        document.getElementById('materialsBudget').addEventListener('input', calculateTotal);
        document.getElementById('viaticBudget').addEventListener('input', calculateTotal);
        
        function calculateTotal() {
            const materials = parseFloat(document.getElementById('materialsBudget').value) || 0;
            const viatic = parseFloat(document.getElementById('viaticBudget').value) || 0;
            const total = materials + viatic;
            document.getElementById('totalBudget').value = total.toLocaleString('es-AR');
        }
        
        // Envío del formulario
        document.getElementById('editProjectForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                idProyecto: document.getElementById('projectId').value,
                nombreProyecto: document.getElementById('projectName').value,
                tipoProyecto: document.getElementById('projectType').value,
                estadoProyecto: document.getElementById('projectStatus').value,
                descripcionProyecto: document.getElementById('projectDescription').value,
                ubicacionProyecto: document.getElementById('projectLocation').value,
                fechaInicio: document.getElementById('startDate').value,
                fechaFin: document.getElementById('endDate').value,
                numeroTrabajadores: parseInt(document.getElementById('workersCount').value),
                presupuestoMateriales: parseFloat(document.getElementById('materialsBudget').value),
                viaticosAsignados: parseFloat(document.getElementById('viaticBudget').value),
                idEmpleado: parseInt(document.getElementById('projectArchitect').value)
            };
            
            try {
                const response = await fetch(`${API_URL}/${projectId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                alert('Proyecto actualizado correctamente');
                window.location.href = `infoProyect.html?id=${projectId}`;
                
            } catch (error) {
                console.error('Error al actualizar proyecto:', error);
                alert(`Error al actualizar proyecto: ${error.message}`);
            }
        });
    </script>
</body>
</html>